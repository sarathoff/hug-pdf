
import pytest
from fastapi.testclient import TestClient
from unittest.mock import patch, MagicMock
import sys
import os

# Add backend directory to sys.path
sys.path.append(os.path.join(os.path.dirname(__file__), '../backend'))

from server import app, get_current_user

# Mock database
# We need more granular control over the mock
mock_supabase = MagicMock()

# Configure the mock to return different things based on the table name
def mock_table(table_name):
    mock_query = MagicMock()
    if table_name == "payment_sessions":
        # Simulate no existing payment session
        mock_query.select.return_value.eq.return_value.execute.return_value.data = []
    elif table_name == "users":
        # Simulate existing user
        mock_query.select.return_value.eq.return_value.execute.return_value.data = [{'credits': 100}]

    # Allow chaining for insert/update
    mock_query.insert.return_value.execute.return_value = None
    mock_query.update.return_value.eq.return_value.execute.return_value = None

    return mock_query

mock_supabase.table.side_effect = mock_table

# Override the get_current_user dependency
async def override_get_current_user():
    return {
        'user_id': "test_user_123",
        'email': 'test@example.com',
        'credits': 100,
        'plan': 'free'
    }

app.dependency_overrides[get_current_user] = override_get_current_user

client = TestClient(app)

def test_payment_success_missing_session_id():
    """
    Test that the payment_success endpoint REJECTS requests without session_id.
    """
    user_id = "test_user_123"
    plan = "pro"

    with patch('server.supabase', mock_supabase):
        # Call the endpoint WITHOUT session_id
        response = client.post(
            f"/api/payment/success?plan={plan}&user_id={user_id}"
        )

        # Should fail with 422 Validation Error (missing required field)
        assert response.status_code == 422

def test_payment_success_with_test_session_id():
    """
    Test that the payment_success endpoint ACCEPTS requests with a test session_id.
    """
    user_id = "test_user_123"
    plan = "pro"
    session_id = "test_session_12345"

    with patch('server.supabase', mock_supabase):
        # Call with valid test session_id
        response = client.post(
            f"/api/payment/success?plan={plan}&user_id={user_id}&session_id={session_id}"
        )

        assert response.status_code == 200
        assert response.json()['success'] == True
        assert response.json()['credits_added'] == 50

        # Verify supabase.table was called with 'users'
        mock_supabase.table.assert_any_call('users')
